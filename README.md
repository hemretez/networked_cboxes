# networked_cboxes

Three folder consist of Pure Data pathces which used to make the C-boxes. 

C-Box runs optimised C code on Bela. All the interaction information received by the sensors is used for controlling the synthesizer. Pitch range of 3 octaves is mapped to y-position of the finger on the TouchKeys sensor. 

If the player applies a lot of force on the sensor, the pitch can be detuned. This relation exists in many traditional instruments such as pulling/pushing the neck of an electric guitar.

The timbre is cross-controlled using filters and distortion depending on the force applied, finger size, and current pitch. The loudness is mapped to both the force applied to the sensor and the finger size. The output levels are calibrated.

Only one finger is registered for sound making. If multiple fingers are placed on the sensor, only the last finger's position is accepted, but the size is still the combined area of all placed fingers up to the sensor's limit. Therefore, using multiple fingers only increases the size parameter which can add the  distortion as intended.

The Heavy API was used to code the network communication among C-Boxes. Message objects in PD were used to pack the information needed to be sent or received over the network using a dedicated wi-fi router. First, a communication protocol was defined in PD in the form of messages. Then, one master-all slave (defining the master as a slave as well) relationship is defined, so that the calculations are only performed in one of the C-Boxes, commands are sent to the router, and distributed over the network. All messages are stored and only executed, when a change made by the master. All boxes have individual ID numbers which define their role, so that there was no need to write different patches for each box. The messages that are sent by the slaves are ignored, unless the receiver is the master. This master/slave relationship and networking avoided having to compile patches one by one which saved a lot of time. The communication frequency is set to 50ms. 

Network Rules:

The hidden constraints are defined for multi-user interaction on the network. The two rules are: i) beat rule and ii) solo rule. Beat rule is implemented for understanding the tendencies of the group, when some external musical material is introduced. A series of beats in a certain tempo is played to see if the group would use these beats to converge to a collaborative behaviour. Solo rule is implemented to understand the consequences, when a player is allowed to play solo (forced by the system). These rules are also integrated in the PD patches and they are only triggered when multiple people are using C-Boxes. 


1.  Beat rule:
This rule is for playing 8 beats from one of the boxes with the average tempo of the three boxes. The tempo value is calculated as beats per minute, however there is no complex beat detection algorithm because as the Heavy API does not support external libraries. Therefore, a much simpler way of tempo detection was chosen - the beats are generated by simple filtering of a sine wave. Here is how this network rule works step by step:


-Whilst playing, the number of total touches are calculated over 40 seconds a for each instrument and simply converted to beats per minute.
-These values are sent over the network at the end of this 40 seconds, then immediately the master box calculates the average and commands the box that has the closest BPM value to this average BPM value to play 8-beats with that average tempo.
-After playing 8-beats, another 40s window opens and this continues until the end of the performance.



2.  Solo rule:
The solo rule is implemented for allowing a user to play solo by muting all others for 10 seconds based on the average loudness value produced by a user for a duration, compared to the average loudness produced by all of the users for that duration. Here is how it works:

-The algorithm calculates the average loudness value in dB(RMS) of an instrument's audio output over a 10-second window.
-If that value is at least 10 percent higher than the average 10-second  value of all the C-Boxes, then that instrument will allow it's user to play solo for 10 seconds: basically the other instruments are muted.
-The calculation window is toggled on and off for each 10 seconds, so that it does not clash with the Beat Rule.
-Also, there is a threshold to trigger this rule: If the 10-second average value is below 60 dB(RMS), then the rule is not triggered, even if that box is at least 10 percent louder than the average. Therefore, the solo rules does not kick in, if the performers choose to stay silent.
